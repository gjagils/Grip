{% extends "base.html" %}
{% set active_nav = "goals" %}

{% block title %}Doelen — Grip{% endblock %}

{% block content %}
<h1><span class="doodle-underline">Doelen</span></h1>
<div class="page-accent page-accent-orange"></div>

<div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
    <button class="btn btn-primary btn-small" onclick="openModal('goal-modal')">+ Nieuw doel</button>
</div>

{% macro goal_card(goal) %}
<div class="card">
    <div class="goal-item">
        <div style="flex: 1;">
            <div class="goal-title">{{ goal.title }}</div>
            {% if goal.description %}
            <div class="goal-meta">{{ goal.description }}</div>
            {% endif %}
            {% if goal.type == 'quarterly' %}
            <div class="goal-meta">{{ goal.quarter }} {{ goal.year }}</div>
            {% endif %}
        </div>
        <div style="display: flex; gap: 0.25rem;">
            <button class="btn btn-small btn-success" onclick="updateGoalStatus({{ goal.id }}, 'completed')" title="Afronden">&#x2713;</button>
        </div>
    </div>

    <!-- Taken bij dit doel -->
    {% set tasks = goal_tasks.get(goal.id, []) %}
    {% if tasks %}
    <div class="task-list" style="margin-top: 0.5rem; border-top: 1.5px dashed var(--border); padding-top: 0.5rem;">
        {% for task in tasks %}
        <div class="task-item" id="goal-task-{{ task.id }}">
            <label class="task-check">
                <input type="checkbox" {% if task.completed %}checked{% endif %}
                       onchange="toggleGoalTask({{ task.id }})">
                <span class="task-label {% if task.completed %}task-done{% endif %}">{{ task.title }}</span>
            </label>
            <button class="task-delete" onclick="deleteGoalTask({{ task.id }})" title="Verwijder">&times;</button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Taak toevoegen -->
    <form method="POST" action="/api/goals/{{ goal.id }}/tasks" class="task-add-form" style="margin-top: 0.5rem;">
        <input type="text" name="title" placeholder="Taak toevoegen..." class="task-add-input">
        <button type="submit" class="btn btn-small btn-secondary">+</button>
    </form>

    {% if tasks %}
    <div class="task-progress" style="margin-top: 0.5rem;">
        {% set done = tasks|selectattr('completed')|list|length %}
        <div class="progress-bar">
            <div class="progress-fill" style="width: {{ (done / tasks|length * 100)|int }}%"></div>
        </div>
        <span class="task-progress-text">{{ done }}/{{ tasks|length }} taken</span>
    </div>
    {% endif %}
</div>
{% endmacro %}

{% if yearly_goals %}
<h2>&#x2B50; Jaardoelen {{ current_year }}</h2>
{% for goal in yearly_goals %}
{{ goal_card(goal) }}
{% endfor %}
{% endif %}

{% if quarterly_goals %}
<h2>&#x1F3AF; Kwartaaldoelen {{ current_quarter }} {{ current_year }}</h2>
{% for goal in quarterly_goals %}
{{ goal_card(goal) }}
{% endfor %}
{% endif %}

{% if not yearly_goals and not quarterly_goals %}
<div class="card card-doodle">
    <div class="empty-state">
        <p>Nog geen actieve doelen</p>
        <p style="margin-top: 0.5rem; font-size: 0.9rem;">Stel je jaar- en kwartaaldoelen in om focus te houden.</p>
    </div>
</div>
{% endif %}

{% if archived_goals %}
<details style="margin-top: 1.5rem;">
    <summary>Afgeronde & verlaten doelen ({{ archived_goals|length }})</summary>
    {% for goal in archived_goals %}
    <div class="card" style="margin-top: 0.5rem; opacity: 0.6;">
        <div class="goal-title">{{ goal.title }}</div>
        <div class="goal-meta">{{ goal.type }} {{ goal.year }}{% if goal.quarter %} {{ goal.quarter }}{% endif %} — {{ goal.status }}</div>
    </div>
    {% endfor %}
</details>
{% endif %}

<!-- Modal: Nieuw doel -->
<div class="modal-overlay" id="goal-modal" onclick="if(event.target===this)closeModal('goal-modal')">
    <div class="modal">
        <h2>Nieuw doel</h2>
        <form method="POST" action="/api/goals">
            <div class="form-group">
                <label>Titel</label>
                <input type="text" name="title" required placeholder="Wat wil je bereiken?">
            </div>
            <div class="form-group">
                <label>Beschrijving (optioneel)</label>
                <textarea name="description" rows="3" placeholder="Meer context..."></textarea>
            </div>
            <div class="form-group">
                <label>Type</label>
                <select name="type" onchange="document.getElementById('quarter-field').style.display = this.value === 'quarterly' ? 'block' : 'none'">
                    <option value="yearly">Jaardoel</option>
                    <option value="quarterly">Kwartaaldoel</option>
                </select>
            </div>
            <div class="form-group" id="quarter-field" style="display: none;">
                <label>Kwartaal</label>
                <select name="quarter">
                    <option value="Q1">Q1 (jan-mrt)</option>
                    <option value="Q2">Q2 (apr-jun)</option>
                    <option value="Q3">Q3 (jul-sep)</option>
                    <option value="Q4">Q4 (okt-dec)</option>
                </select>
            </div>
            <input type="hidden" name="year" value="{{ current_year }}">
            <button type="submit" class="btn btn-primary">Doel opslaan</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function openModal(id) {
    document.getElementById(id).classList.add('active');
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

async function updateGoalStatus(goalId, status) {
    await fetch(`/api/goals/${goalId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status })
    });
    location.reload();
}

async function toggleGoalTask(taskId) {
    await fetch(`/api/goal-tasks/${taskId}/toggle`, { method: 'POST' });
    const label = document.querySelector(`#goal-task-${taskId} .task-label`);
    label.classList.toggle('task-done');
}

async function deleteGoalTask(taskId) {
    await fetch(`/api/goal-tasks/${taskId}`, { method: 'DELETE' });
    document.getElementById(`goal-task-${taskId}`).remove();
}
</script>
{% endblock %}
